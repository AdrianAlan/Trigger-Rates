import pandas as pd
import numpy as np
import json

links = pd.DataFrame()

runs = ['304797', '304778', '304777', '304776', '304740', '304739',
       '304738', '304737', '304672', '304671', '304663', '304662',
       '304661', '304655', '304654', '304625', '304616', '304562',
       '304508', '304507', '304506', '304505', '304451', '304447',
       '304446', '304366', '304354', '304333', '304292', '304291',
       '304209', '304204', '304200', '304199', '304198', '304196',
       '304170', '304169', '304158', '304144', '304125', '304120',
       '304119', '304062', '304000', '303999', '303989', '303948',
       '303885', '303838', '303832', '303825', '302663', '302661',
       '302654', '302651', '302635', '302634', '302597', '302596',
       '302573', '302572', '302571', '302570', '302567', '302566',
       '302555', '302553', '302548', '302526', '302525', '302523',
       '302522', '302513', '302509', '302494', '302492', '302485',
       '302484', '302479', '302476', '302474', '302473', '302472',
       '302448', '302393', '302392', '302388', '302350', '302344',
       '302343', '302342', '302337', '302328', '302322', '302280',
       '302279', '302277', '302263', '302262', '302240', '302229',
       '302228', '302225', '302166', '302165', '302163', '302159',
       '302131', '302043', '302042', '302041', '302040', '302037',
       '302036', '302034', '302033', '302031', '302029', '302026',
       '302019', '301998', '301997', '301987', '301986', '301985',
       '301984', '301969', '301960', '301959', '301941', '301914',
       '301913', '301912', '301694', '301665', '301664', '301627',
       '301567', '301532', '301531', '301530', '301529', '301528',
       '301525', '301524', '301519', '301480', '301476', '301475',
       '301472', '301461', '301450', '301449', '301448', '301447',
       '301417', '301399', '301397', '301396', '301394', '301393',
       '301392', '301391', '301384', '301359', '301330', '301323',
       '301298', '301283', '301281', '301183', '301180', '301179',
       '301165', '301161', '301142', '301141', '301086', '301046',
       '300817', '300816', '300812', '300811', '300806', '300785',
       '300781', '300780', '300777', '300742', '300676', '300675',
       '300674', '300673', '300636', '300635', '300633', '300632',
       '300631', '300576', '300575', '300574', '300560', '300558',
       '300552', '300551', '300548', '300545', '300539', '300538',
       '300517', '300516', '300515', '300514', '300498', '300497',
       '300467', '300466', '300464', '300463', '300462', '300461',
       '300459', '300401', '300400', '300399', '300398', '300397',
       '300396', '300395', '300394', '300393', '300392', '300391',
       '300390', '300389', '300375', '300374', '300373', '300371',
       '300370', '300369', '300368', '300367', '300366', '300365',
       '300364', '300284', '300283', '300282', '300280', '300240',
       '300239', '300238', '300237', '300236', '300235', '300234',
       '300233', '300226', '300157', '300156', '300155', '300124',
       '300123', '300122', '300117', '300107', '300106', '300105',
       '300087', '300079']

for run in runs:
    print("Loading %s" % run, end="\r")
    path = "./data/links%s.csv" % (run)
    try:
        links = links.append(pd.read_csv(path, names=["run", "hlt", "l1"]), ignore_index=True);
    except FileNotFoundError:
        pass
    
print("Done. Collected %s layers" % links.shape[0], end="\r")


json_nodes = []
json_links = []

triggers = np.append(links.hlt.unique(), links.l1.unique())

for x, name in enumerate(triggers):
    item = {"group": x, "name": name.strip()}
    json_nodes.append(item)
    
for _, row in links.drop_duplicates(subset=["hlt", "l1"]).iterrows():
    hlt = row['hlt']
    l1t = row['l1']
    
    source = np.where(triggers == l1t)[0][0]
    target = np.where(triggers == hlt)[0][0]
    weight = len(links[(links.hlt == hlt) & (links.l1 == l1t)])
    
    item = {"source":int(source), "target":int(target), "weight":int(weight)}
    
    json_links.append(item)
    
export_json = {"nodes": json_nodes, "links": json_links}

with open('./seeds-graph/static/graphFile.json', 'w') as f:
    json.dump(export_json, f)
